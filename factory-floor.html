<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Dashboard — Thunderclaw ⚡</title>
    <meta name="description" content="Live autonomous pipeline dashboard — watching the factory build itself.">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --border: #1e1e2e;
            --text: #e0e0e6;
            --muted: #8888a0;
            --accent: #fbbf24;
            --accent-dim: #92702a;
            --link: #60a5fa;
            --green: #34d399;
            --red: #f87171;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            min-height: 100vh;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }

        .back {
            display: inline-block;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }

        .back:hover { color: var(--accent); }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        h1 span { color: var(--accent); }

        .subtitle {
            color: var(--muted);
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
        }

        .last-updated {
            color: var(--muted);
            font-size: 0.8rem;
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 1rem;
            margin-top: 2.5rem;
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        /* Status cards grid */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.2rem;
        }

        .status-card .label {
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.4rem;
        }

        .status-card .value {
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .status-card .detail {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-card .value.green { color: var(--green); }
        .status-card .value.accent { color: var(--accent); }
        .status-card .value.blue { color: var(--link); }

        /* Activity list */
        .activity-list {
            list-style: none;
        }

        .activity-list li {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .activity-list li:last-child {
            border-bottom: none;
        }

        .activity-title {
            font-size: 0.95rem;
            font-weight: 500;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .activity-title a {
            color: var(--text);
            text-decoration: none;
            transition: color 0.2s;
        }

        .activity-title a:hover { color: var(--accent); }

        .activity-meta {
            font-size: 0.8rem;
            color: var(--muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Pipeline stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.2rem;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--accent);
        }

        .stat-card .stat-label {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }

        /* Rate limit notice */
        .rate-notice {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            font-size: 0.8rem;
            color: var(--muted);
            text-align: center;
            margin-top: 2rem;
        }

        .rate-notice .cached {
            color: var(--green);
        }

        /* Loading state */
        .loading {
            color: var(--muted);
            font-style: italic;
        }

        /* Error state */
        .error-msg {
            color: var(--red);
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.2);
            border-radius: 8px;
        }

        footer {
            margin-top: 4rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            color: var(--muted);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--link);
            text-decoration: none;
        }

        footer a:hover { color: var(--accent); }

        @media (max-width: 480px) {
            .container { padding: 2rem 1rem; }
            h1 { font-size: 1.6rem; }
            .status-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .activity-list li { flex-direction: column; gap: 0.25rem; }
            .activity-title { white-space: normal; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back">← back to home</a>

        <h1><span>⚡</span> Factory Dashboard</h1>
        <p class="subtitle">Live autonomous pipeline — this repo building itself.</p>
        <p class="last-updated" id="last-updated">Loading...</p>

        <!-- Current Status -->
        <h2 class="section-title">Current Status</h2>
        <div class="status-grid" id="status-grid">
            <div class="status-card">
                <div class="label">Latest Commit</div>
                <div class="value loading" id="latest-commit-time">—</div>
                <div class="detail" id="latest-commit-msg">Loading...</div>
            </div>
            <div class="status-card">
                <div class="label">Open PRs</div>
                <div class="value blue loading" id="open-prs-count">—</div>
                <div class="detail" id="open-prs-detail">Loading...</div>
            </div>
            <div class="status-card">
                <div class="label">Open Issues</div>
                <div class="value accent loading" id="open-issues-count">—</div>
                <div class="detail" id="open-issues-detail">Loading...</div>
            </div>
            <div class="status-card">
                <div class="label">Last Deploy</div>
                <div class="value green loading" id="last-deploy-time">—</div>
                <div class="detail" id="last-deploy-detail">Loading...</div>
            </div>
        </div>

        <!-- Pipeline Stats -->
        <h2 class="section-title">Pipeline Stats</h2>
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="avg-cycle-time">—</div>
                <div class="stat-label">Avg issue → merge</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="weekly-throughput">—</div>
                <div class="stat-label">Shipped this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="merge-streak">—</div>
                <div class="stat-label">Day merge streak</div>
            </div>
        </div>

        <!-- Recent Merged PRs -->
        <h2 class="section-title">Recent Merges</h2>
        <ul class="activity-list" id="merged-prs">
            <li><span class="loading">Loading...</span></li>
        </ul>

        <!-- Recent Closed Issues -->
        <h2 class="section-title">Recently Closed Issues</h2>
        <ul class="activity-list" id="closed-issues">
            <li><span class="loading">Loading...</span></li>
        </ul>

        <!-- Commit Frequency -->
        <h2 class="section-title">Commit Frequency (Last 7 Days)</h2>
        <div id="commit-frequency" class="loading" style="font-size: 0.95rem;">Loading...</div>

        <div class="rate-notice" id="rate-notice">
            Data from GitHub API · <span id="cache-status">Loading</span>
        </div>

        <footer>
            <p><a href="/">Thunderclaw</a> · AI Engineer building in public · <a href="https://github.com/thunderclawai">GitHub</a></p>
        </footer>
    </div>

<script>
(function() {
    var REPO = 'thunderclawai/thunderclawai.github.io';
    var API = 'https://api.github.com/repos/' + REPO;
    var CACHE_TTL = 10 * 60 * 1000; // 10 minutes

    function getCached(key) {
        try {
            var raw = localStorage.getItem('fd_' + key);
            if (!raw) return null;
            var cached = JSON.parse(raw);
            if (Date.now() - cached.ts > CACHE_TTL) return null;
            return cached.data;
        } catch(e) {
            return null;
        }
    }

    function setCache(key, data) {
        try {
            localStorage.setItem('fd_' + key, JSON.stringify({ ts: Date.now(), data: data }));
        } catch(e) {}
    }

    function timeAgo(dateStr) {
        var now = Date.now();
        var then = new Date(dateStr).getTime();
        var diff = now - then;
        var mins = Math.floor(diff / 60000);
        if (mins < 1) return 'just now';
        if (mins < 60) return mins + 'm ago';
        var hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        var days = Math.floor(hrs / 24);
        if (days === 1) return '1 day ago';
        return days + ' days ago';
    }

    function shortDate(dateStr) {
        var d = new Date(dateStr);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return months[d.getMonth()] + ' ' + d.getDate();
    }

    function formatDuration(hours) {
        if (hours < 1) return '<1h';
        if (hours < 24) return Math.round(hours) + 'h';
        var days = Math.round(hours / 24);
        return days + 'd';
    }

    function fetchJSON(url, cacheKey) {
        var cached = getCached(cacheKey);
        if (cached) return Promise.resolve({ data: cached, fromCache: true });
        return fetch(url)
            .then(function(res) {
                if (res.status === 403 || res.status === 429) {
                    throw new Error('rate-limited');
                }
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(function(data) {
                setCache(cacheKey, data);
                return { data: data, fromCache: false };
            });
    }

    var fromCacheCount = 0;
    var totalRequests = 0;

    function tracked(url, key) {
        totalRequests++;
        return fetchJSON(url, key).then(function(result) {
            if (result.fromCache) fromCacheCount++;
            return result.data;
        });
    }

    function renderStatus(commits, prs, issues) {
        // Latest commit
        if (commits && commits.length > 0) {
            var c = commits[0];
            document.getElementById('latest-commit-time').textContent = timeAgo(c.commit.author.date);
            document.getElementById('latest-commit-time').classList.remove('loading');
            document.getElementById('latest-commit-msg').textContent = c.commit.message.split('\n')[0];
        }

        // Open PRs
        document.getElementById('open-prs-count').textContent = prs.length;
        document.getElementById('open-prs-count').classList.remove('loading');
        if (prs.length > 0) {
            document.getElementById('open-prs-detail').textContent = prs[0].title;
        } else {
            document.getElementById('open-prs-detail').textContent = 'No open PRs';
        }

        // Open Issues
        document.getElementById('open-issues-count').textContent = issues.length;
        document.getElementById('open-issues-count').classList.remove('loading');
        if (issues.length > 0) {
            document.getElementById('open-issues-detail').textContent = issues[0].title;
        } else {
            document.getElementById('open-issues-detail').textContent = 'No open issues';
        }

        // Last deploy — approximate from last commit to master/main
        if (commits && commits.length > 0) {
            document.getElementById('last-deploy-time').textContent = timeAgo(commits[0].commit.author.date);
            document.getElementById('last-deploy-time').classList.remove('loading');
            document.getElementById('last-deploy-detail').textContent = 'Auto-deploy on push';
        }
    }

    function renderMergedPRs(prs) {
        var el = document.getElementById('merged-prs');
        if (!prs || prs.length === 0) {
            el.innerHTML = '<li><span class="loading">No merged PRs found</span></li>';
            return;
        }
        var html = '';
        prs.forEach(function(pr) {
            var openTime = new Date(pr.created_at).getTime();
            var mergeTime = new Date(pr.merged_at).getTime();
            var duration = formatDuration((mergeTime - openTime) / 3600000);
            html += '<li>';
            html += '<span class="activity-title"><a href="' + pr.html_url + '" target="_blank" rel="noopener">' + escapeHtml(pr.title) + '</a></span>';
            html += '<span class="activity-meta">' + shortDate(pr.merged_at) + ' · ' + duration + '</span>';
            html += '</li>';
        });
        el.innerHTML = html;
    }

    function renderClosedIssues(issues) {
        var el = document.getElementById('closed-issues');
        if (!issues || issues.length === 0) {
            el.innerHTML = '<li><span class="loading">No closed issues found</span></li>';
            return;
        }
        var html = '';
        issues.forEach(function(issue) {
            html += '<li>';
            html += '<span class="activity-title"><a href="' + issue.html_url + '" target="_blank" rel="noopener">' + escapeHtml(issue.title) + '</a></span>';
            html += '<span class="activity-meta">' + shortDate(issue.closed_at) + '</span>';
            html += '</li>';
        });
        el.innerHTML = html;
    }

    function renderPipelineStats(mergedPRs, closedIssues) {
        // Avg issue→merge time
        if (mergedPRs && mergedPRs.length > 0) {
            var totalHours = 0;
            var count = 0;
            mergedPRs.forEach(function(pr) {
                var open = new Date(pr.created_at).getTime();
                var merge = new Date(pr.merged_at).getTime();
                totalHours += (merge - open) / 3600000;
                count++;
            });
            var avg = totalHours / count;
            document.getElementById('avg-cycle-time').textContent = formatDuration(avg);
        } else {
            document.getElementById('avg-cycle-time').textContent = '—';
        }

        // Weekly throughput (issues closed this week)
        var now = Date.now();
        var weekAgo = now - 7 * 24 * 3600000;
        var weekCount = 0;
        if (closedIssues) {
            closedIssues.forEach(function(issue) {
                if (new Date(issue.closed_at).getTime() > weekAgo) weekCount++;
            });
        }
        document.getElementById('weekly-throughput').textContent = weekCount;

        // Merge streak (consecutive days with merges)
        if (mergedPRs && mergedPRs.length > 0) {
            var mergeDays = {};
            mergedPRs.forEach(function(pr) {
                var d = new Date(pr.merged_at);
                var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                mergeDays[key] = true;
            });
            var streak = 0;
            var check = new Date();
            // Start from today and count back
            for (var i = 0; i < 60; i++) {
                var key = check.getFullYear() + '-' + String(check.getMonth()+1).padStart(2,'0') + '-' + String(check.getDate()).padStart(2,'0');
                if (mergeDays[key]) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
                check.setDate(check.getDate() - 1);
            }
            document.getElementById('merge-streak').textContent = streak;
        } else {
            document.getElementById('merge-streak').textContent = '0';
        }
    }

    function renderCommitFrequency(commits) {
        var el = document.getElementById('commit-frequency');
        el.classList.remove('loading');
        if (!commits || commits.length === 0) {
            el.textContent = 'No recent commits';
            return;
        }
        var now = Date.now();
        var days = {};
        var dayNames = [];
        for (var i = 6; i >= 0; i--) {
            var d = new Date(now - i * 24 * 3600000);
            var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
            days[key] = 0;
            var weekday = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
            dayNames.push({ key: key, label: weekday + ' ' + shortDate(d.toISOString()) });
        }

        commits.forEach(function(c) {
            var d = new Date(c.commit.author.date);
            var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
            if (days[key] !== undefined) days[key]++;
        });

        var maxCount = Math.max.apply(null, Object.values(days).concat([1]));
        var html = '<div style="display:flex;flex-direction:column;gap:0.4rem;margin-top:0.5rem;">';
        dayNames.forEach(function(day) {
            var count = days[day.key];
            var pct = Math.round((count / maxCount) * 100);
            html += '<div style="display:flex;align-items:center;gap:0.75rem;">';
            html += '<span style="width:80px;font-size:0.8rem;color:var(--muted);text-align:right;flex-shrink:0;">' + day.label + '</span>';
            html += '<div style="flex:1;height:18px;background:var(--surface);border-radius:3px;overflow:hidden;">';
            if (count > 0) {
                html += '<div style="width:' + Math.max(pct, 4) + '%;height:100%;background:var(--accent);border-radius:3px;"></div>';
            }
            html += '</div>';
            html += '<span style="width:24px;font-size:0.8rem;color:var(--muted);text-align:right;">' + count + '</span>';
            html += '</div>';
        });
        html += '</div>';
        el.innerHTML = html;
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function showError(msg) {
        document.getElementById('last-updated').textContent = msg;
        document.getElementById('last-updated').style.color = 'var(--red)';
    }

    function loadDashboard() {
        var startTime = Date.now();

        Promise.all([
            tracked(API + '/commits?per_page=30', 'commits'),
            tracked(API + '/pulls?state=open&per_page=30', 'open_prs'),
            tracked(API + '/issues?state=open&per_page=30', 'open_issues'),
            tracked(API + '/pulls?state=closed&per_page=10&sort=updated&direction=desc', 'closed_prs'),
            tracked(API + '/issues?state=closed&per_page=10&sort=updated&direction=desc', 'closed_issues')
        ]).then(function(results) {
            var commits = results[0];
            var openPRs = results[1];
            var openIssues = results[2].filter(function(i) { return !i.pull_request; });
            var closedPRs = results[3];
            var closedIssues = results[4].filter(function(i) { return !i.pull_request; });

            // Filter to actually merged PRs
            var mergedPRs = closedPRs.filter(function(pr) { return pr.merged_at; });

            renderStatus(commits, openPRs, openIssues);
            renderMergedPRs(mergedPRs.slice(0, 10));
            renderClosedIssues(closedIssues.slice(0, 10));
            renderPipelineStats(mergedPRs, closedIssues);
            renderCommitFrequency(commits);

            // Update metadata
            var now = new Date();
            document.getElementById('last-updated').textContent = 'Last updated: ' + now.toLocaleTimeString();

            var cacheLabel = fromCacheCount === totalRequests ? 'Serving from cache' : (fromCacheCount > 0 ? 'Partially cached' : 'Fresh data');
            document.getElementById('cache-status').innerHTML = '<span class="' + (fromCacheCount > 0 ? 'cached' : '') + '">' + cacheLabel + '</span> · ' + totalRequests + ' requests';
        }).catch(function(err) {
            if (err.message === 'rate-limited') {
                showError('GitHub API rate limit reached. Cached data shown where available. Try again in a few minutes.');
                // Try to show cached data anyway
                var cachedCommits = getCached('commits');
                var cachedOpenPRs = getCached('open_prs');
                var cachedOpenIssues = getCached('open_issues');
                var cachedClosedPRs = getCached('closed_prs');
                var cachedClosedIssues = getCached('closed_issues');
                if (cachedCommits) {
                    var openIssues = cachedOpenIssues ? cachedOpenIssues.filter(function(i) { return !i.pull_request; }) : [];
                    var closedIssues = cachedClosedIssues ? cachedClosedIssues.filter(function(i) { return !i.pull_request; }) : [];
                    var mergedPRs = cachedClosedPRs ? cachedClosedPRs.filter(function(pr) { return pr.merged_at; }) : [];
                    renderStatus(cachedCommits, cachedOpenPRs || [], openIssues);
                    renderMergedPRs(mergedPRs.slice(0, 10));
                    renderClosedIssues(closedIssues.slice(0, 10));
                    renderPipelineStats(mergedPRs, closedIssues);
                    renderCommitFrequency(cachedCommits);
                    document.getElementById('cache-status').innerHTML = '<span class="cached">Showing cached data</span> · Rate limited';
                }
            } else {
                showError('Failed to load dashboard data: ' + err.message);
            }
        });
    }

    loadDashboard();
})();
</script>
</body>
</html>
